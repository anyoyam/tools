const ExpressionParser=function(){const e={18:["(",")"],17:[".","[","]"],14:["!","~"],13:["**"],12:["*","/","%"],11:["+","-"],10:["<<",">>",">>>"],9:["<","<=",">",">="],8:["==","!=","===","!=="],7:["&"],6:["^"],5:["|"],4:["&&"],3:["||"],2:["?",":"],1:[","]},l=[],a=Object.keys(e).reverse().reduce((t,r)=>{t.length;return e[r].map((e,o)=>{l.push(r),t.push(e)}),t},[]),t={isNumber:e=>/^\d+(\.\d+)?$/.test(e),isBoolean:e=>"true"===e.toLowerCase()||"false"===e.toLowerCase(),isString:e=>"''"===e||'""'===e||/^'[^']+?'$/.test(e)||/^"[^"]+?"$/.test(e),isNull:e=>"null"===e.toLowerCase(),isUndefined:e=>"undefined"===e.toLowerCase()};function d(e){let o=null;return e&&e.type?e:("string"==typeof e&&t.isNumber(e)||"number"==typeof e?o={type:"number",val:Number(e)}:"boolean"==typeof e?o={type:"boolean",val:!0===e}:"string"==typeof e&&t.isBoolean(e)?o={type:"boolean",val:"true"===e.toLowerCase()}:"string"==typeof e&&t.isString(e)?o={type:"string",val:e.substring(1,e.length-1)}:"string"==typeof e&&t.isNull(e)||null===e?o={type:"null",val:null}:("string"==typeof e&&t.isUndefined(e)||void 0===e)&&(o={type:"undefined",val:void 0}),o)}const w={"!":e=>!e.val,"~":e=>~e.val,"**":(e,o)=>e.val**o.val,"*":(e,o)=>e.val*o.val,"/":(e,o)=>e.val/o.val,"%":(e,o)=>e.val%o.val,"+":(e,o)=>e.val+o.val,"-":(e,o)=>e.val-o.val,"<<":(e,o)=>e.val<<o.val,">>":(e,o)=>e.val>>o.val,">>>":(e,o)=>e.val>>>o.val,"<":(e,o)=>e.val<o.val,"<=":(e,o)=>e.val<=o.val,">":(e,o)=>e.val>o.val,">=":(e,o)=>e.val>=o.val,"==":(e,o)=>e.val==o.val,"!=":(e,o)=>e.val!=o.val,"===":(e,o)=>e.val===o.val,"!==":(e,o)=>e.val!==o.val,"&":(e,o)=>e.val&o.val,"^":(e,o)=>e.val^o.val,"|":(e,o)=>e.val|o.val,"&&":(e,o)=>e.val&&o.val,"||":(e,o)=>e.val||o.val,"?":(e,o,t)=>(e.val?o:t).val,",":(e,o)=>(e.val,o.val)};return{parse:function(e,o){console.log(e),e=function(e){let o=[];o.push(e);const t=[...a];return["&","|"].map(e=>t.splice(t.indexOf(e),1)),t.push("&"),t.push("|"),t.map(t=>{const r=[];o.map(o=>{if(-1<a.indexOf(o))r.push(o);else{let e=o.indexOf(t);for(;-1<e&&0<o.length;)0<e&&r.push(o.substring(0,e)),r.push(o.substring(e,e+t.length)),o=o.substring(e+t.length),e=o.indexOf(t);o&&r.push(o)}}),r.length&&(o=[...r])}),o}(e),console.log(e),e=e.map((e,o)=>o=null===(o=-1<a.indexOf(e)?{type:"opeator",precedence:l[a.indexOf(e)],opeator:e}:d(e))?{type:"identifier",val:e}:o),console.log(e),e=function a(n,p,i){const s=[];for(let l=0;l<n.length;l++){var f=n[l];if("opeator"===f.type&&"("===f.opeator){const u={type:"group",child:null,precedence:f.precedence};let e=0,o=n[++l],t=0,r=!1;const y=[];do{if(e++,0==t&&"opeator"===o.type&&")"===o.opeator){r=!0,e--;break}}while("opeator"!==o.type||"("!==o.opeator&&")"!==o.opeator||("("===o.opeator?t++:t--),y.push(o),o=n[++l]);if(!r)throw new Error("未找到对应)");if(u.child=a(y,p),i&&i.parameter)return{data:u,offset:e};s.push(u)}else if("identifier"===f.type){let e=null;if(void 0===p||void 0===p[f.val])throw new Error(p+" or "+f.val+" is not defined.");let o=n[++l],t=n[++l],r=p[f.val];if(!o||"opeator"!==o.type||"."!==o.opeator&&"["!==o.opeator)if(o&&"opeator"===o.type&&"("===o.opeator){if("function"!=typeof p[f.val])throw new Error("function "+f.val+" is not defined!");var v=a(n.slice(l-1),p,{parameter:!0});l+=v.offset,v=v.data.child.reduce((e,o,t)=>((0===t||"opeator"===o.type&&","===o.opeator)&&e.push([]),"opeator"===o.type&&","===o.opeator||e[e.length-1].push(o),e),[]),r={type:"function",precedence:"18",fnName:f.val,params:v}}else l-=2;else for("["===o.opeator&&++l;;){if(!t||"identifier"!==t.type&&"number"!==t.type&&"string"!==t.type)throw console.info("---无法从中取到",r,o,t),new Error("无法从中取到");if(r=r[t.val],o=n[++l],t=n[++l],!o||!t){if(!o||t)break;if("opeator"===o.type)throw new Error("表达式异常. 不能以"+o.opeator+"结尾");r=r[o.val];break}if("opeator"!==o.type||"opeator"===o.type&&"."!==o.opeator&&"["!==o.opeator){l-=2;break}if("["===o.opeator&&("opeator"!==n[l+1].type||"]"!==n[l+1].opeator))throw new Error("表达式异常。[]取值没有对应的 ]；注[]取值中间暂不支持表达式");if("["===o.opeator&&l++,"object"!=typeof r||null===r||void 0===r)throw console.info("---无法从null/undefined/非对象 取子节点",r,o,t),new Error("无法从null/undefined/非对象 取子节点")}null===(e=d(r))&&(e={type:typeof r,val:r}),s.push(e)}else s.push(f)}return s}(e,o),console.log(e),e=function l(a,n){let p=(a=a.map(e=>{let o=null;if("group"===e.type)o=l(e.child,n);else{if("function"!==e.type)return e;var t=e.params.map(e=>l(e,n).val);o=n[e.fnName].apply(this,t)}let r=d(o);return r=null===r?{type:typeof o,val:o}:r})).length;for(;1<p;){const h=[];a.map(e=>"opeator"===e.type&&"18"!=e.precedence&&-1===h.indexOf(e.precedence)&&h.push(Number(e.precedence))),h.sort((e,o)=>o-e);var i=h[0];let o=-1,t=null;for(let e=0;e<a.length;e++){var s=a[e];if("opeator"===s.type&&Number(s.precedence)===i&&(o=e,t=s,13!==i))break}if(-1===o||null===t)throw new Error("没有找到优先级的"+i+"操作符");const c=w[t.opeator];if(!c)throw new Error("操作符"+t.opeator+"不存在");var f=a[o-1],v=a[o+1];let e=null,r=-1,l=0;if(14===i){if(!v||"opeator"===v.type)throw new Error("操作符"+t.opeator+"需要一个right运算数");if("~"!==t.opeator||"!"!==t.opeator)throw new Error("操作符不属于单运算数操作符~,!;【"+t.opeator+"】");r=o,l=2,e=c(v)}else if(2===i){var u=a[o+2],y=a[o+3];if(!f||"opeator"===f.type)throw new Error("操作符"+t.opeator+"需要一个运算数作为条件");if(!v||"opeator"===v.type)throw new Error("操作符"+t.opeator+"需要一个运算数作为truthy返回值");if(!u||"opeator"!==u.type||":"!=u.opeator)throw new Error("操作符"+t.opeator+"需要一个:操作符");if(!y||"opeator"===y.type)throw new Error("操作符"+t.opeator+"需要一个运算数作为falsy返回值");r=o-1,l=5,e=c(f,v,y)}else{if(!f||"opeator"===f.type)throw new Error("操作符"+t.opeator+"需要一个left运算数");if(!v||"opeator"===v.type)throw new Error("操作符"+t.opeator+"需要一个right运算数");r=o-1,l=3,e=c(f,v)}if(u=d(e),e=null===u?{type:typeof e,val:e}:u,-1<r&&0<l&&e&&a.splice(r,l,e),a.length==p)throw new Error("????");p=a.length}return a[0]}(e,o),console.log(e)}}}();